{% set grid_size = theme_var('grid-size') %}

<script src="/user/themes/quark/js/bricklayer.min.js"></script>
<script src="/user/themes/quark/js/scopedQuerySelectorShim.min.js"></script>
<link href="/user/themes/quark/css/bricklayer.css" type="text/css" rel="stylesheet">
<link href="/user/themes/myquark/css/reviews-custom.css" type="text/css" rel="stylesheet">

<section class="section modular-text {{ page.header.class}}">
  <section class="container {{ grid_size }}">

    {{ page.content | raw }}

    {# --- filtering & limits --------------------------------------------- #}
    {% set tags_to_filter = header_var('review-tags') | defined([]) %}
    {% set limit = header_var('limit') | defined(10) | int %}

    {# Build full filtered collection, then slice first batch #}
    {% set all = taxonomy.findTaxonomy({'category': 'review'}) %}
    {% if tags_to_filter|length > 0 %}
      {% set all = all
        | filter(p => (p.taxonomy()['review-tag'] ?? []) | filter(t => t in tags_to_filter) | length > 0)
      %}
    {% endif %}
    {% set all = all | sort | reverse %}
    {% set total_count = all|length %}
    {% set initial = all | slice(0, limit) %}

    <div class="bricklayer" id="testimonial-wall">
      {% for review in initial %}
        {% include 'partials/review-card.html.twig' with { review: review } %}
      {% endfor %}
    </div>

    {% if total_count > limit %}
      <div class="text-center mt-2">
        <button id="reviews-load-more"
                class="btn btn-primary"
                data-limit="{{ limit }}"
                data-offset="{{ limit }}"
                data-tags="{{ tags_to_filter|join(',')|e('html_attr') }}">
          Show more
        </button>
        <div id="reviews-loader" class="loading" style="display:none;"></div>
      </div>
    {% endif %}

  </section>
</section>

<script>
(function () {
  var wall   = document.getElementById('testimonial-wall');
  var btn    = document.getElementById('reviews-load-more');
  var loader = document.getElementById('reviews-loader');

  // Init Bricklayer
  var bricklayer = new Bricklayer(wall);

  if (!btn) return;

  var API_URL = 'https://mathspp.com/api/testimonials.json';

  function buildUrl(limit, offset, tagsCSV) {
    var url = new URL(API_URL);
    url.searchParams.set('limit', String(limit));
    url.searchParams.set('offset', String(offset));
    if (tagsCSV && tagsCSV.trim() !== '') {
      url.searchParams.set('review-tag', tagsCSV);
    }
    return url.toString();
  }

  function htmlStringToNode(html) {
    var tpl = document.createElement('template');
    tpl.innerHTML = html.trim();
    return tpl.content.firstElementChild;
  }

  function getColumns() {
    return wall.querySelectorAll('.bricklayer-column');
  }

  function shortestColumn(columns) {
    var minCol = null;
    var minH = Infinity;
    columns.forEach ? columns.forEach(check) : Array.prototype.forEach.call(columns, check);
    function check(col) {
      var h = col.getBoundingClientRect().height;
      if (h < minH) { minH = h; minCol = col; }
    }
    return minCol || wall; // fallback to wall pre-init
  }

  // Append a single card respecting Bricklayer's columns
  function appendCard(node) {
    // Prefer official API if present
    if (bricklayer && typeof bricklayer.append === 'function') {
      bricklayer.append(node);
      return;
    }
    // Fallback: manual column placement
    var cols = getColumns();
    if (cols.length) {
      shortestColumn(cols).appendChild(node);
    } else {
      // If columns not created yet (edge case), just append to wall
      wall.appendChild(node);
    }
  }

  // Optional: after images load, nudge layout
  function onImagesLoad(el, cb) {
    var imgs = el.querySelectorAll('img');
    if (!imgs.length) { cb(); return; }
    var remaining = imgs.length;
    imgs.forEach ? imgs.forEach(doneOrWait) : Array.prototype.forEach.call(imgs, doneOrWait);
    function doneOrWait(img) {
      if (img.complete) { if (--remaining === 0) cb(); }
      else {
        img.addEventListener('load', function () { if (--remaining === 0) cb(); });
        img.addEventListener('error', function () { if (--remaining === 0) cb(); });
      }
    }
  }

  btn.addEventListener('click', async function () {
    var limit  = parseInt(btn.dataset.limit || '10', 10);
    var offset = parseInt(btn.dataset.offset || '0', 10);
    var tags   = btn.dataset.tags || '';

    btn.disabled = true;
    if (loader) loader.style.display = '';

    try {
      const res = await fetch(buildUrl(limit, offset, tags), {
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error('Failed to load more testimonials');
      const data = await res.json();

      var fragment = document.createDocumentFragment();
      var appendedCount = 0;

      if (Array.isArray(data.items)) {
        data.items.forEach(function (html) {
          var node = htmlStringToNode(html);
          if (node) {
            // queue in fragment first (for image load hook), then append to columns
            fragment.appendChild(node);
            appendedCount += 1;
          }
        });
      }

      // Wait for images to settle, then distribute items to columns
      onImagesLoad(fragment, function () {
        // Move children out of fragment and into columns one by one
        while (fragment.firstChild) {
          appendCard(fragment.firstChild);
        }
        // Try to trigger a layout pass if API available
        if (bricklayer && typeof bricklayer.redraw === 'function') {
          bricklayer.redraw();
        } else {
          // Nudge layout by triggering a resize event as a last resort
          window.dispatchEvent(new Event('resize'));
        }
      });

      // Update offset
      btn.dataset.offset = String(offset + (data.count || appendedCount));

      // Hide button if no more
      if (!data.has_more || (data.count || appendedCount) === 0) {
        btn.style.display = 'none';
      }
    } catch (err) {
      console.error(err);
      btn.textContent = 'Try again';
      btn.disabled = false;
    } finally {
      if (loader) loader.style.display = 'none';
      if (btn && btn.style.display !== 'none') btn.disabled = false;
    }
  });
})();
</script>
