{% set grid_size = theme_var('grid-size') %}

<script src="/user/themes/quark/js/bricklayer.min.js"></script>
<script src="/user/themes/quark/js/scopedQuerySelectorShim.min.js"></script>
<script src="/user/themes/quark/js/testimonial-loader.js"></script>
<link href="/user/themes/quark/css/bricklayer.css" type="text/css" rel="stylesheet">
<link href="/user/themes/myquark/css/reviews-custom.css" type="text/css" rel="stylesheet">

<section class="section modular-text {{ page.header.class}}">
  <section class="container {{ grid_size }}">

    {{ page.content | raw }}

    {# --- filtering & limits --------------------------------------------- #}
    {% set tags_to_filter = header_var('review-tags') | defined([]) %}
    {% set limit = header_var('limit') | defined(10) | int %}

    {# Build full filtered collection, then slice first batch #}
    {% set all = taxonomy.findTaxonomy({'category': 'review'}) %}
    {% if tags_to_filter|length > 0 %}
      {% set all = all
        | filter(p => (p.taxonomy()['review-tag'] ?? []) | filter(t => t in tags_to_filter) | length > 0)
      %}
    {% endif %}
    {% set all = all | sort | reverse %}
    {% set total_count = all|length %}
    {% set initial = all | slice(0, limit) %}

    <div class="bricklayer" id="testimonial-wall">
      {% for review in initial %}
        {% include 'partials/review-card.html.twig' with { review: review } %}
      {% endfor %}
    </div>

    {% if total_count > limit %}
      <div class="text-center mt-2">
        <button id="reviews-load-more"
                class="btn"
                data-limit="{{ limit }}"
                data-offset="{{ limit }}"
                data-tags="{{ tags_to_filter|join(',')|e('html_attr') }}">
          Load more
        </button>
        <div id="reviews-loader" class="loading" style="display:none;"></div>
      </div>
    {% endif %}

  </section>
</section>
